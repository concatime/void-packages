# Template file for 'weston'
pkgname=weston
version=9.0.0
revision=1
build_style=meson
configure_args="-Dbackend-rdp=false -Dremoting=false -Dsystemd=false
 -Dtest-junit-xml=false
 -Dbackend-drm-screencast-vaapi=$(vopt_if vaapi true false)
 -Dlauncher-logind=$(vopt_if elogind true false)
 -Dpipewire=$(vopt_if pipewire true false)
 -Drenderer-gl=$(vopt_if vaapi true false)"
hostmakedepends="pkg-config wayland-devel wayland-protocols"
makedepends="cairo-devel colord-devel dbus-devel eudev-libudev-devel
 lcms2-devel libXcursor-devel libdrm-devel libinput-devel libpng-devel
 libwebp-devel libxcb-devel libxkbcommon-devel mtdev-devel pam-devel pango-devel
 pipewire-devel pixman-devel poppler-glib-devel wayland-devel wayland-protocols
 $(vopt_if elogind elogind-devel) $(vopt_if vaapi 'glu-devel libva-devel')"
short_desc="Reference implementation of a Wayland compositor"
maintainer="Orphaned <orphan@voidlinux.org>"
license="MIT"
homepage="https://wayland.freedesktop.org"
distfiles="https://wayland.freedesktop.org/releases/${pkgname}-${version}.tar.xz"
checksum=5cf5d6ce192e0eb15c1fc861a436bf21b5bb3b91dbdabbdebe83e1f83aa098fe
system_groups="weston-launch"
lib32disabled=yes

# Package build options
build_options="elogind pipewire vaapi"
build_options_default="pipewire"
desc_option_elogind="Use elogind for suidless startup"
desc_option_pipewire="Enable virtual remote output with Pipewire on DRM backend"
desc_option_vaapi="Enable DRM/KMS backend support for VA-API screencasting"

case "$XBPS_TARGET_MACHINE" in
	x86_64*|i686*|aarch64*|ppc*)
		build_options_default+=" vaapi"
		;;
	armv*)
		configure_args+=" -Ddemo-clients=false -Dsimple-clients=[]"
		;;
esac

pre_configure() {
	: #vsed -i "/subdir('tests')/d" meson.build
}

post_install() {
	# weston-launch must be setuid
	if [ -z "$build_option_elogind" ]; then
		chmod u+s ${DESTDIR}/usr/bin/weston-launch
	fi
	vlicense COPYING LICENSE
	# Remove development files.
	rm -rf ${DESTDIR}/usr/include
	rm -rf ${DESTDIR}/usr/lib/pkgconfig
}

weston-colord_package() {
	short_desc+=" - colord plugin"
	pkg_install() {
		vmove /usr/lib/weston/cms-colord.so
	}
}

weston-x11_package() {
	short_desc+=" - x11 backend"
	depends="weston"
	pkg_install() {
		vmove "/usr/lib/libweston-${version%%.*}/x11-backend.so"
	}
}

weston-xwayland_package() {
	short_desc+=" - xwayland backend"
	pkg_install() {
		vmove "/usr/lib/libweston-${version%%.*}/xwayland.so"
	}
}
